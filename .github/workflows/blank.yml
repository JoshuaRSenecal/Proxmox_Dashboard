#!/usr/bin/env python3
import requests
import urllib3
urllib3.disable_warnings()

# Configuration
HOST = "192.168.1.100"  # Change this
USER = "root@pam"        # Change this
PASSWORD = "your_password"  # Change this

class Proxmox:
    def __init__(self, host, user, password):
        self.base = f"https://{host}:8006/api2/json"
        r = requests.post(f"{self.base}/access/ticket", 
                         data={'username': user, 'password': password}, verify=False)
        d = r.json()['data']
        self.cookies = {'PVEAuthCookie': d['ticket']}
        self.headers = {'CSRFPreventionToken': d['CSRFPreventionToken']}
    
    def get(self, path):
        return requests.get(f"{self.base}{path}", cookies=self.cookies, verify=False).json()['data']
    
    def post(self, path):
        return requests.post(f"{self.base}{path}", headers=self.headers, cookies=self.cookies, verify=False)

def fmt(b):
    if not b or b == 'N/A': return 'N/A'
    b = float(b)
    for u in ['B','KB','MB','GB','TB']:
        if b < 1024: return f"{b:.1f}{u}"
        b /= 1024

def show(px):
    items = []
    for node in px.get('/nodes'):
        n = node['node']
        
        # VMs
        for vm in px.get(f'/nodes/{n}/qemu'):
            cfg = px.get(f'/nodes/{n}/qemu/{vm["vmid"]}/config')
            stat = px.get(f'/nodes/{n}/qemu/{vm["vmid"]}/status/current')
            
            # Memory: balloon (min) to maxmem (max) - both in bytes, need conversion
            balloon = int(cfg.get('balloon', 0)) * 1024 * 1024 if cfg.get('balloon') else 0
            maxmem = int(cfg.get('memory', 0)) * 1024 * 1024 if cfg.get('memory') else 0
            
            # Get total disk size from config - look for the primary disk
            total_disk = 0
            for key in sorted(cfg.keys()):
                if key.startswith(('scsi0', 'sata0', 'ide0', 'virtio0')):
                    value = str(cfg[key])
                    # Parse the disk config string
                    if ':' in value:
                        parts = value.split(',')
                        for part in parts:
                            if 'size=' in part:
                                size_str = part.split('size=')[1].strip()
                                if size_str.endswith('G'):
                                    total_disk = float(size_str[:-1]) * 1024 * 1024 * 1024
                                elif size_str.endswith('M'):
                                    total_disk = float(size_str[:-1]) * 1024 * 1024
                                elif size_str.endswith('T'):
                                    total_disk = float(size_str[:-1]) * 1024 * 1024 * 1024 * 1024
                                break
                    if total_disk > 0:
                        break
            
            # Disk usage - VMs need agent for accurate disk usage
            disk_free = 'N/A'
            disk_free_pct = 'N/A'
            
            if vm['status'] == 'running':
                # Try to get filesystem info from agent
                try:
                    agent_data = px.get(f'/nodes/{n}/qemu/{vm["vmid"]}/agent/get-fsinfo')
                    if agent_data and 'result' in agent_data:
                        total_fs = 0
                        used_fs = 0
                        
                        # Sum up all real filesystems (skip ISO/cdrom)
                        for fs in agent_data['result']:
                            mp = fs.get('mountpoint', fs.get('target', ''))
                            fs_type = fs.get('type', '')
                            
                            # Skip CD-ROM/ISO mounts
                            if fs_type in ['iso9660', 'udf']:
                                continue
                            
                            # Include root and boot partitions
                            if mp in ['/', '/boot', '/home', '/var', '/tmp', '/usr']:
                                total = fs.get('total-bytes', 0)
                                used = fs.get('used-bytes', 0)
                                if total > 0 and used >= 0:
                                    total_fs += total
                                    used_fs += used
                        
                        if total_fs > 0:
                            free_bytes = total_fs - used_fs
                            disk_free = fmt(free_bytes)
                            disk_free_pct = (free_bytes / total_fs * 100)
                except:
                    pass
            
            items.append({
                'id': vm['vmid'], 'name': vm['name'], 'type': 'VM',
                'status': vm['status'], 'node': n,
                'cores': cfg.get('cores', 'N/A'),
                'mem': f"{fmt(balloon)} - {fmt(maxmem)}",
                'total_disk': fmt(total_disk) if total_disk > 0 else 'N/A',
                'free_disk': disk_free,
                'free': disk_free_pct
            })
        
        # Containers
        for ct in px.get(f'/nodes/{n}/lxc'):
            cfg = px.get(f'/nodes/{n}/lxc/{ct["vmid"]}/config')
            stat = px.get(f'/nodes/{n}/lxc/{ct["vmid"]}/status/current')
            
            # Memory and swap - already in bytes
            memory = int(cfg.get('memory', 0)) * 1024 * 1024 if cfg.get('memory') else 0
            swap = int(cfg.get('swap', 0)) * 1024 * 1024 if cfg.get('swap') else 0
            
            # Get total disk from rootfs config
            total_disk = 0
            rootfs = cfg.get('rootfs', '')
            if 'size=' in str(rootfs):
                size_str = str(rootfs).split('size=')[1].split(',')[0].strip()
                if size_str.endswith('G'):
                    total_disk = float(size_str[:-1]) * 1024 * 1024 * 1024
                elif size_str.endswith('M'):
                    total_disk = float(size_str[:-1]) * 1024 * 1024
                elif size_str.endswith('T'):
                    total_disk = float(size_str[:-1]) * 1024 * 1024 * 1024 * 1024
            
            # Disk usage - containers report this reliably when running
            disk_free = 'N/A'
            disk_free_pct = 'N/A'
            
            if ct['status'] == 'running':
                disk_used = stat.get('disk', 0)
                disk_max = stat.get('maxdisk', 0)
                if disk_max > 0:
                    free_bytes = disk_max - disk_used
                    disk_free = fmt(free_bytes)
                    disk_free_pct = (free_bytes / disk_max * 100)
            
            items.append({
                'id': ct['vmid'], 'name': ct['name'], 'type': 'CT',
                'status': ct['status'], 'node': n,
                'cores': cfg.get('cores', 'N/A'),
                'mem': f"{fmt(memory)} - {fmt(swap)}",
                'total_disk': fmt(total_disk) if total_disk > 0 else 'N/A',
                'free_disk': disk_free,
                'free': disk_free_pct
            })
    
    items.sort(key=lambda x: x['id'])
    
    print("\n" + "="*130)
    print(f"{'ID':<6} {'Type':<4} {'Status':<10} {'Name':<20} {'Node':<12} {'Cores':<6} {'Memory':<20} {'Total Disk':<12} {'Free Disk':<12} {'Free%':<8}")
    print("-"*130)
    for i in items:
        free_display = f"{i['free']:.1f}%" if isinstance(i['free'], (int, float)) else i['free']
        print(f"{i['id']:<6} {i['type']:<4} {i['status']:<10} {i['name']:<20} {i['node']:<12} {i['cores']:<6} {i['mem']:<20} {i['total_disk']:<12} {i['free_disk']:<12} {free_display:<8}")
    print("="*130)
    return items

def menu(px, items):
    print("\n1. Start VM/CT  2. Stop VM/CT  3. Start all stopped  4. Refresh  5. Exit")
    c = input("Choice: ").strip()
    
    if c == '1':
        vid = input("ID: ").strip()
        i = next((x for x in items if str(x['id'])==vid), None)
        if i:
            px.post(f"/nodes/{i['node']}/{'qemu' if i['type']=='VM' else 'lxc'}/{i['id']}/status/start")
            print(f"✓ Started {i['type']} {i['id']}")
    
    elif c == '2':
        vid = input("ID: ").strip()
        i = next((x for x in items if str(x['id'])==vid), None)
        if i:
            px.post(f"/nodes/{i['node']}/{'qemu' if i['type']=='VM' else 'lxc'}/{i['id']}/status/stop")
            print(f"✓ Stopped {i['type']} {i['id']}")
    
    elif c == '3':
        for i in [x for x in items if x['status']!='running']:
            px.post(f"/nodes/{i['node']}/{'qemu' if i['type']=='VM' else 'lxc'}/{i['id']}/status/start")
            print(f"✓ Started {i['type']} {i['id']}")
    
    elif c == '5':
        return False
    
    return True

px = Proxmox(HOST, USER, PASSWORD)
while True:
    if not menu(px, show(px)): break
