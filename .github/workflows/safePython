#!/usr/bin/env python3
import requests
import urllib3
import sys
import getpass
urllib3.disable_warnings()

# Get credentials from command line or prompt
if len(sys.argv) == 4:
    HOST = sys.argv[1]
    USER = sys.argv[2]
    PASSWORD = sys.argv[3]
else:
    print("Proxmox VM/Container Dashboard")
    print("-" * 50)
    HOST = input("Proxmox host (e.g., 192.168.1.100): ").strip()
    USER = input("Username (e.g., root@pam): ").strip()
    PASSWORD = getpass.getpass("Password: ")

if not HOST or not USER or not PASSWORD:
    print("Error: Host, username, and password are required.")
    sys.exit(1)

class Proxmox:
    def __init__(self, host, user, password):
        self.base = f"https://{host}:8006/api2/json"
        print(f"Attempting to connect to: {self.base}")
        print(f"Username: {user}")
        r = requests.post(f"{self.base}/access/ticket", 
                         data={'username': user, 'password': password}, 
                         verify=False)
        if r.status_code != 200:
            print(f"Authentication failed: {r.status_code}")
            print(f"Response: {r.text}")
            print("\nPlease verify:")
            print("1. Username includes realm (e.g., root@pam)")
            print("2. Password is correct")
            print("3. Host is accessible on port 8006")
            sys.exit(1)
        d = r.json()['data']
        self.cookies = {'PVEAuthCookie': d['ticket']}
        self.headers = {'CSRFPreventionToken': d['CSRFPreventionToken']}
        print("✓ Authentication successful!")
    
    def get(self, path):
        return requests.get(f"{self.base}{path}", cookies=self.cookies, verify=False).json()['data']
    
    def post(self, path):
        return requests.post(f"{self.base}{path}", headers=self.headers, cookies=self.cookies, verify=False)

def fmt(b):
    if not b or b == 'N/A': return 'N/A'
    b = float(b)
    for u in ['B','KiB','MiB','GiB','TiB']:
        if b < 1024: return f"{b:.1f}{u}"
        b /= 1024

def show(px):
    items = []
    for node in px.get('/nodes'):
        n = node['node']
        
        # VMs
        for vm in px.get(f'/nodes/{n}/qemu'):
            cfg = px.get(f'/nodes/{n}/qemu/{vm["vmid"]}/config')
            stat = px.get(f'/nodes/{n}/qemu/{vm["vmid"]}/status/current')
            
            # Memory: balloon (min) to maxmem (max) - both in bytes, need conversion
            balloon = int(cfg.get('balloon', 0)) * 1024 * 1024 if cfg.get('balloon') else 0
            maxmem = int(cfg.get('memory', 0)) * 1024 * 1024 if cfg.get('memory') else 0
            
            # CPU info
            cores = cfg.get('cores', 'N/A')
            sockets = cfg.get('sockets', 'N/A')
            cpu_type = cfg.get('cpu', 'N/A')
            
            # Get total disk size from config - look for the primary disk
            total_disk = 0
            for key in sorted(cfg.keys()):
                if key.startswith(('scsi0', 'sata0', 'ide0', 'virtio0')):
                    value = str(cfg[key])
                    # Parse the disk config string
                    if ':' in value:
                        parts = value.split(',')
                        for part in parts:
                            if 'size=' in part:
                                size_str = part.split('size=')[1].strip()
                                if size_str.endswith('G'):
                                    total_disk = float(size_str[:-1]) * 1024 * 1024 * 1024
                                elif size_str.endswith('M'):
                                    total_disk = float(size_str[:-1]) * 1024 * 1024
                                elif size_str.endswith('T'):
                                    total_disk = float(size_str[:-1]) * 1024 * 1024 * 1024 * 1024
                                break
                    if total_disk > 0:
                        break
            
            # Disk usage - VMs need agent for accurate disk usage
            disk_free = 'N/A'
            disk_free_pct = 'N/A'
            total_filesystem = 'N/A'
            
            if vm['status'] == 'running':
                # Try to get filesystem info from agent
                try:
                    agent_data = px.get(f'/nodes/{n}/qemu/{vm["vmid"]}/agent/get-fsinfo')
                    if agent_data and 'result' in agent_data:
                        total_fs = 0
                        avail_fs = 0
                        
                        # Sum up all real filesystems (skip ISO/cdrom and tmpfs)
                        for fs in agent_data['result']:
                            mp = fs.get('mountpoint', fs.get('target', ''))
                            fs_type = fs.get('type', '')
                            
                            # Skip CD-ROM/ISO mounts and tmpfs/devtmpfs (RAM filesystems)
                            if fs_type in ['iso9660', 'udf', 'tmpfs', 'devtmpfs']:
                                continue
                            
                            # Include only real disk-based filesystems
                            if mp in ['/', '/boot', '/home', '/var', '/tmp', '/usr']:
                                total = fs.get('total-bytes', 0)
                                used = fs.get('used-bytes', 0)
                                if total > 0 and used >= 0:
                                    total_fs += total
                                    avail_fs += (total - used)
                        
                        if total_fs > 0 and avail_fs > 0:
                            total_filesystem = fmt(total_fs)
                            disk_free = fmt(avail_fs)
                            disk_free_pct = (avail_fs / total_fs * 100)
                except:
                    pass
            
            items.append({
                'id': vm['vmid'], 'name': vm['name'], 'type': 'VM',
                'status': vm['status'], 'node': n,
                'cores': cores,
                'sockets': sockets,
                'cpu_type': cpu_type,
                'mem': f"{fmt(balloon)} - {fmt(maxmem)}",
                'total_disk': fmt(total_disk) if total_disk > 0 else 'N/A',
                'total_filesystem': total_filesystem,
                'free_disk': disk_free,
                'free': disk_free_pct
            })
        
        # Containers
        for ct in px.get(f'/nodes/{n}/lxc'):
            cfg = px.get(f'/nodes/{n}/lxc/{ct["vmid"]}/config')
            stat = px.get(f'/nodes/{n}/lxc/{ct["vmid"]}/status/current')
            
            # Memory and swap - already in bytes
            memory = int(cfg.get('memory', 0)) * 1024 * 1024 if cfg.get('memory') else 0
            swap = int(cfg.get('swap', 0)) * 1024 * 1024 if cfg.get('swap') else 0
            
            # CPU info
            cores = cfg.get('cores', 'N/A')
            sockets = 'N/A'  # Containers don't have sockets
            cpu_type = 'N/A'  # Containers don't have CPU type
            
            # Get total disk from rootfs config
            total_disk = 0
            rootfs = cfg.get('rootfs', '')
            if 'size=' in str(rootfs):
                size_str = str(rootfs).split('size=')[1].split(',')[0].strip()
                if size_str.endswith('G'):
                    total_disk = float(size_str[:-1]) * 1024 * 1024 * 1024
                elif size_str.endswith('M'):
                    total_disk = float(size_str[:-1]) * 1024 * 1024
                elif size_str.endswith('T'):
                    total_disk = float(size_str[:-1]) * 1024 * 1024 * 1024 * 1024
            
            # Disk usage - containers report this reliably when running
            disk_free = 'N/A'
            disk_free_pct = 'N/A'
            total_filesystem = 'N/A'
            
            if ct['status'] == 'running':
                disk_used = stat.get('disk', 0)
                disk_max = stat.get('maxdisk', 0)
                if disk_max > 0:
                    free_bytes = disk_max - disk_used
                    total_filesystem = fmt(disk_max)
                    disk_free = fmt(free_bytes)
                    disk_free_pct = (free_bytes / disk_max * 100)
            
            items.append({
                'id': ct['vmid'], 'name': ct['name'], 'type': 'CT',
                'status': ct['status'], 'node': n,
                'cores': cores,
                'sockets': sockets,
                'cpu_type': cpu_type,
                'mem': f"{fmt(memory)} - {fmt(swap)}",
                'total_disk': fmt(total_disk) if total_disk > 0 else 'N/A',
                'total_filesystem': total_filesystem,
                'free_disk': disk_free,
                'free': disk_free_pct
            })
    
    items.sort(key=lambda x: x['id'])
    
    print("\n" + "="*170)
    print(f"{'ID':<6} {'Type':<4} {'Status':<10} {'Name':<20} {'Node':<12} {'Cores':<6} {'Sockets':<8} {'CPU Type':<15} {'Memory':<20} {'Total Disk':<12} {'Total FS':<12} {'Free Disk':<12} {'Free%':<8}")
    print("-"*170)
    for i in items:
        free_display = f"{i['free']:.1f}%" if isinstance(i['free'], (int, float)) else i['free']
        print(f"{i['id']:<6} {i['type']:<4} {i['status']:<10} {i['name']:<20} {i['node']:<12} {i['cores']:<6} {i['sockets']:<8} {i['cpu_type']:<15} {i['mem']:<20} {i['total_disk']:<12} {i['total_filesystem']:<12} {i['free_disk']:<12} {free_display:<8}")
    print("="*170)
    return items

def menu(px, items):
    print("\n1. Start VM/CT  2. Stop VM/CT  3. Start all stopped  4. Refresh  5. Exit")
    c = input("Choice: ").strip()
    
    if c == '1':
        vid = input("ID: ").strip()
        i = next((x for x in items if str(x['id'])==vid), None)
        if i:
            px.post(f"/nodes/{i['node']}/{'qemu' if i['type']=='VM' else 'lxc'}/{i['id']}/status/start")
            print(f"✓ Started {i['type']} {i['id']}")
    
    elif c == '2':
        vid = input("ID: ").strip()
        i = next((x for x in items if str(x['id'])==vid), None)
        if i:
            px.post(f"/nodes/{i['node']}/{'qemu' if i['type']=='VM' else 'lxc'}/{i['id']}/status/stop")
            print(f"✓ Stopped {i['type']} {i['id']}")
    
    elif c == '3':
        for i in [x for x in items if x['status']!='running']:
            px.post(f"/nodes/{i['node']}/{'qemu' if i['type']=='VM' else 'lxc'}/{i['id']}/status/start")
            print(f"✓ Started {i['type']} {i['id']}")
    
    elif c == '5':
        return False
    
    return True

px = Proxmox(HOST, USER, PASSWORD)
print("\nConnecting to Proxmox...")
try:
    while True:
        if not menu(px, show(px)): break
except KeyboardInterrupt:
    print("\n\nExiting...")
except Exception as e:
    print(f"\nError: {e}")
    sys.exit(1)
